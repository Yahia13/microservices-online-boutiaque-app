image: gitpod/workspace-full

tasks:
  - name: setup
    init: |
      set -euo pipefail

      # Base tools
      sudo apt-get update -y
      sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
        curl unzip gnupg lsb-release ca-certificates jq tree apt-transport-https

      # --- Terraform (official APT repo) ---
      curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
      echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | \
        sudo tee /etc/apt/sources.list.d/hashicorp.list >/dev/null
      sudo apt-get update -y
      sudo DEBIAN_FRONTEND=noninteractive apt-get install -y terraform

      # --- AWS CLI v2 ---
      curl -sSL "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
      unzip -q awscliv2.zip
      sudo ./aws/install --update
      rm -rf aws awscliv2.zip

      # --- kubectl (latest stable) ---
      KVER="$(curl -L -s https://dl.k8s.io/release/stable.txt)"
      curl -L -o kubectl "https://dl.k8s.io/release/${KVER}/bin/linux/amd64/kubectl"
      sudo install -m 0755 kubectl /usr/local/bin/kubectl
      rm -f kubectl

      # --- Helm ---
      curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

    command: |
      clear
      echo "Terraform: $(terraform -version | head -n1)"
      echo "AWS CLI: $(aws --version)"
      echo "kubectl: $(kubectl version --client --short)"
      echo "Helm: $(helm version --short)"
  - name: clear
    command: clear
